# Nmap — Varredura de Portas e Discovery

## Introdução

**Nmap** (Network Mapper) é a ferramenta mais popular para descoberta de hosts, mapeamento de portas e identificação de serviços.

## Instalação

```bash
# Linux
sudo apt install nmap

# macOS
brew install nmap

# Windows
# Baixar de: nmap.org/download
```

---

## Conceitos Básicos

### Estados de Porta

- **Open**: Aplicação escutando
- **Closed**: Porta respondendo, mas sem serviço
- **Filtered**: Firewall bloqueando
- **Unfiltered**: Porta respondida, mas status desconhecido
- **Open|Filtered**: Nmap não conseguiu determinar

---

## Tipos de Scan

### SYN Scan (Padrão, Requer root)
```bash
sudo nmap -sS 192.168.1.100
```
- Rápido e discreto
- Conexão TCP incompleta
- Não registra logs

### TCP Connect Scan
```bash
nmap -sT 192.168.1.100
```
- Sem privilégios root
- Completa três vias do TCP
- Deixa logs

### UDP Scan
```bash
sudo nmap -sU 192.168.1.100
```
- Escaneia UDP (DNS, DHCP)
- Mais lento
- Requer root

### ACK Scan (Firewall Mapping)
```bash
sudo nmap -sA 192.168.1.100
```
- Não descobre portas abertas
- Descobre firewall rules

---

## Opções Comuns

### Especificar Alvo

```bash
nmap 192.168.1.100           # IP único
nmap 192.168.1.0/24          # Subnet inteira
nmap 192.168.1.1-100         # Range de IPs
nmap scanme.nmap.org         # Hostname
nmap -iL targets.txt         # Lista de arquivo
```

### Especificar Portas

```bash
nmap -p 22 alvo              # Porta específica
nmap -p 22,80,443 alvo       # Múltiplas portas
nmap -p 1-1000 alvo          # Range de portas
nmap -p- alvo                # Todas as 65535 portas
nmap -p-U:53,111 alvo        # TCP e UDP
```

### Descoberta de Hosts

```bash
nmap -sn 192.168.1.0/24      # Ping scan (sem port scan)
nmap -Pn alvo                # Ignorar ping (assume host up)
nmap -PS 192.168.1.0/24      # SYN ping
nmap -PA 192.168.1.0/24      # ACK ping
nmap -PU alvo                # UDP ping
```

### Detecção de Versão e OS

```bash
nmap -sV alvo                # Detectar versões de serviço
nmap -O alvo                 # Detectar Sistema Operacional (requer root)
nmap -A alvo                 # Agressivo (scripts, versão, OS, traceroute)
nmap -sV --version-intensity 9 alvo  # Versão mais agressiva
```

---

## Exemplos Práticos

### Scan Rápido
```bash
nmap 192.168.1.100
```

### Scan Completo
```bash
nmap -sV -sC -O -A 192.168.1.100
```

### Scan de Rede Inteira
```bash
nmap -sn 192.168.1.0/24      # Descobrir hosts
nmap -p- 192.168.1.100       # Todas as portas
```

### Scan Sigiloso
```bash
sudo nmap -sS -T2 -f 192.168.1.100
```
- `-sS`: SYN scan
- `-T2`: Timing lento
- `-f`: Fragmentar pacotes

### Scan com Scripts NSE
```bash
nmap -sV --script smb-os-discovery 192.168.1.100
nmap --script vuln 192.168.1.100
```

---

## NSE (Nmap Scripting Engine)

### Scripts Úteis

```bash
# SMB vulnerabilities
nmap --script smb-vuln-* alvo

# HTTP
nmap --script http-title alvo
nmap --script http-enum alvo

# SSH
nmap --script ssh-hostkey alvo

# DNS
nmap --script dns-brute alvo
```

### Localizar Scripts
```bash
ls /usr/share/nmap/scripts/
```

---

## Opções de Timing

```bash
-T0   # Paranoid (muito lento)
-T1   # Sneaky
-T2   # Polite
-T3   # Normal (padrão)
-T4   # Aggressive
-T5   # Insane (muito rápido)
```

---

## Saída e Relatórios

```bash
nmap -oN output.txt alvo           # Formato normal
nmap -oX output.xml alvo           # XML
nmap -oG output.grep alvo          # Grepable
nmap -oA output alvo               # Todos os formatos
```

### Processar Saída

```bash
# Extrair IPs abertos
nmap -oG - 192.168.1.0/24 | grep "Ports:" | grep "open"

# Com xmllint
nmap -oX output.xml alvo
xmllint --format output.xml
```

---

## Tabela de Referência Rápida

| Comando | Descrição |
|---------|-----------|
| `nmap target` | Scan padrão |
| `nmap -sn target` | Ping scan |
| `nmap -p- target` | Todas as portas |
| `nmap -sV target` | Detecção de versão |
| `nmap -O target` | Detecção de SO |
| `nmap -A target` | Agressivo |
| `nmap -T4 target` | Timing agressivo |
| `nmap --script vuln target` | Scan de vulnerabilidades |

---

## Dicas de Segurança

✅ Usar em ambientes autorizados
✅ Documentar scans
✅ Usar timeouts apropriados
✅ Começar com scans menos intrusivos

❌ Não fazer scan em redes públicas
❌ Não ignorar logs de atividade
❌ Não usar sem permissão
❌ Não deixar fragmentação permanente

---

Próximo: `whois-dig.md` para coleta de informações de domínio.
